<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>تسجيل رحلة العمرة 2026 - دخول</title>
  <style>
    *{box-sizing:border-box}
    body{font-family:Arial,sans-serif;background:#f6f7fb;margin:0;padding:28px}
    .card{max-width:520px;margin:auto;background:#fff;padding:22px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    h2{margin:0 0 14px;text-align:center}
    label{display:block;margin:12px 0 6px;font-weight:700}
    input{width:100%;padding:11px;border-radius:10px;border:1px solid #d8d8d8}
    button{width:100%;margin-top:16px;padding:13px 16px;background:#2e7d32;color:#fff;border:0;border-radius:12px;cursor:pointer;font-size:16px}
    button:disabled{opacity:.6;cursor:not-allowed}
    .msg{margin-top:14px;padding:12px;border-radius:12px;background:#f1f5ff;color:#123;display:none}
    .err{background:#fff3f3;color:#900}
  </style>
</head>
<body>
  <div class="card">
    <h2>دخول تسجيل رحلة العمرة 2026</h2>

    <label>الرقم المدني</label>
    <input id="civil" inputmode="numeric" placeholder="مثال: 123456789012"/>

    <label>رقم الصندوق</label>
    <input id="box" inputmode="numeric" placeholder="مثال: 12345"/>

    <button id="btn" onclick="check()">دخول</button>
    <div id="out" class="msg"></div>
  </div>

<script>
  // رابط الـ Web App بعد Deploy
  const API_URL = "https://script.google.com/macros/s/AKfycbwCZv09zM2yklxDhjRUf3gU3KdQpXz7zazUfFpaEftr6oLRo_Ur2g6KattcXjJY3VvZOg/exec";

  // ✅ POST ثابت
  async function apiPost(obj){
    const r = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(obj)
    });
    return await r.json();
  }

  function showMsg(text, type){
    const out = document.getElementById("out");
    out.className = "msg" + (type === "err" ? " err" : "");
    out.textContent = text;
    out.style.display = "block";
  }

  async function check(){
    const civil = document.getElementById("civil").value.trim();
    const box = document.getElementById("box").value.trim();
    const btn = document.getElementById("btn");

    document.getElementById("out").style.display = "none";

    if(!civil || !box){
      showMsg("من فضلك اكتب الرقم المدني ورقم الصندوق.", "err");
      return;
    }

    btn.disabled = true;
    btn.textContent = "جاري التحقق...";

    try{
      const res = await apiPost({ action:"check", civil_id:civil, box_number:box });

      if(!res || res.ok !== true){
        showMsg((res && (res.message || res.error)) ? (res.message || res.error) : "حصل خطأ أثناء الاتصال.", "err");
        return;
      }

      // ✅ NEW: لو مسجل قبل كده → روح لصفحة نجاح (هنعملها بعدين)
      if(res.code === "ALREADY_REGISTERED" || res.alreadyRegistered === true){
        sessionStorage.setItem("civil_id", civil);
        sessionStorage.setItem("box_number", box);

        location.href = "success.html?civil_id="
          + encodeURIComponent(civil)
          + "&box_number="
          + encodeURIComponent(box)
          + (res.request_id ? "&request_id=" + encodeURIComponent(res.request_id) : "")
          + "&already=1";
        return;
      }

      if(res.eligible){
        // ✅ خزّن بيانات الدخول
        sessionStorage.setItem("umrah_login", JSON.stringify(res.applicant || { civil_id:civil, box_number:box }));
        sessionStorage.setItem("civil_id", civil);
        sessionStorage.setItem("box_number", box);

        // ✅ تحويل للفورم مع الباراميترز
        location.href = "form.html?civil_id="
          + encodeURIComponent(civil)
          + "&box_number="
          + encodeURIComponent(box);

      }else{
        showMsg(res.message || "عذرًا، غير مؤهل للتقديم.", "err");
      }

    }catch(e){
      showMsg("حصل خطأ أثناء الاتصال. حاول مرة أخرى.", "err");
    }finally{
      btn.disabled = false;
      btn.textContent = "دخول";
    }
  }
</script>
</body>
</html>
