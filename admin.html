<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>لوحة التحكم - عمرة 2026</title>
  <style>
    *{box-sizing:border-box}
    body{font-family:Arial,sans-serif;background:#f6f7fb;margin:0;padding:24px}
    .wrap{max-width:1200px;margin:auto}
    .card{background:#fff;border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    h2{margin:0 0 12px;text-align:center}
    .muted{color:#666;text-align:center;margin:0 0 16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input,select,button{padding:11px 12px;border-radius:10px;border:1px solid #d8d8d8;font-size:14px}
    button{background:#2e7d32;color:#fff;border:0;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .stat{background:#fafafa;border:1px solid #eee;border-radius:14px;padding:12px}
    .stat b{display:block;font-size:18px;margin-top:4px}
    .msg{margin:12px 0;padding:12px;border-radius:12px;display:none}
    .ok{background:#f3fff3;color:#070}
    .err{background:#fff3f3;color:#900}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid #eee;padding:10px;vertical-align:top;font-size:13px}
    th{background:#fafafa;text-align:right}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    a{color:#2e7d32;text-decoration:none}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef2ff;border:1px solid #e5e7eb;font-size:12px}
    .small{font-size:12px;color:#666}

    /* Modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9999;padding:18px}
    .modal .box{max-width:980px;margin:auto;background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .modal .head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;background:#fafafa;border-bottom:1px solid #eee}
    .modal .head b{font-size:14px}
    .modal .close{background:#777;border:0;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
    .modal .content{padding:14px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .imgCard{border:1px solid #eee;border-radius:14px;padding:10px;background:#fff}
    .imgCard .title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .imgCard img{width:100%;height:auto;border-radius:12px;border:1px solid #eee;background:#f7f7f7}
    .imgCard .fallback{padding:14px;border-radius:12px;background:#fafafa;border:1px dashed #ddd;text-align:center;color:#777}
    .imgCard .openLink{font-size:12px}

    @media (max-width: 980px){
      .grid{grid-template-columns:repeat(2,minmax(0,1fr))}
      .modal .content{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>لوحة التحكم - تسجيل عمرة 2026</h2>
    <p class="muted">إحصائيات + بحث + تحديث حالة الطلب</p>

    <div id="msg" class="msg"></div>

    <!-- Login -->
    <div id="loginBox">
      <div class="row" style="justify-content:center">
        <input id="pw" type="password" placeholder="كلمة مرور الأدمن" style="min-width:280px">
        <button id="btnLogin" onclick="login()">دخول</button>
      </div>
      <p class="muted small">يتم حفظ التوكن في المتصفح لمدة محدودة.</p>
    </div>

    <!-- Admin -->
    <div id="adminBox" style="display:none">
      <div class="grid" style="margin-top:10px">
        <div class="stat">إجمالي الطلبات<b id="st_total">0</b></div>
        <div class="stat">طلبات بمرافق<b id="st_with">0</b></div>
        <div class="stat">بدون مرافق<b id="st_without">0</b></div>
        <div class="stat">حالات الطلب<b id="st_statuses">-</b></div>
      </div>

      <div class="row" style="margin-top:14px">
        <input id="q" placeholder="بحث: رقم مدني / صندوق / اسم / request_id" style="flex:1;min-width:260px">
        <select id="f_has">
          <option value="">مرافق: الكل</option>
          <option value="YES">نعم</option>
          <option value="NO">لا</option>
        </select>

        <!-- ✅ Status filter as dropdown -->
        <select id="f_status" style="min-width:220px">
          <option value="">Status: الكل</option>
          <option value="PENDING">PENDING</option>
          <option value="RECEIVED">RECEIVED</option>
          <option value="APPROVED">APPROVED</option>
          <option value="REJECTED">REJECTED</option>
          <option value="CANCELLED">CANCELLED</option>
        </select>

        <button id="btnSearch" onclick="loadList(0)">بحث</button>
        <button onclick="refreshAll()">تحديث</button>

        <!-- ✅ Export CSV -->
        <button style="background:#0f766e" onclick="exportCSV()">Export CSV</button>

        <button style="background:#777" onclick="logout()">خروج</button>
      </div>

      <div class="small" style="margin-top:8px">
        <span class="pill">ملاحظة</span>
        تحديث الـ status يتم من القائمة مباشرة ثم “حفظ”.
      </div>

      <div style="overflow:auto;margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>الوقت</th>
              <th>request_id</th>
              <th>المسافر</th>
              <th>المرافق</th>
              <th>الصور</th>
              <th>status</th>
              <th>إجراء</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div class="row" style="justify-content:space-between;margin-top:12px">
        <div class="small" id="pageInfo"></div>
        <div class="row">
          <button id="prev" onclick="prevPage()">السابق</button>
          <button id="next" onclick="nextPage()">التالي</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ✅ Image Modal -->
<div id="imgModal" class="modal" onclick="modalBackdropClose(event)">
  <div class="box" onclick="event.stopPropagation()">
    <div class="head">
      <b id="imgModalTitle">عرض الصور</b>
      <button class="close" onclick="closeImgModal()">إغلاق</button>
    </div>
    <div class="content">
      <div class="imgCard">
        <div class="title">
          <b>صور المسافر</b>
          <a id="travOpen1" class="openLink" target="_blank" rel="noopener" href="#" style="display:none">فتح الأصل</a>
        </div>
        <img id="travImg1" alt="هوية المسافر" style="display:none">
        <div id="travFallback1" class="fallback">لا توجد صور للمسافر.</div>
        <div class="small" style="margin-top:8px" id="travLinks"></div>
      </div>

      <div class="imgCard">
        <div class="title">
          <b>صور المرافق</b>
          <a id="compOpen1" class="openLink" target="_blank" rel="noopener" href="#" style="display:none">فتح الأصل</a>
        </div>
        <img id="compImg1" alt="هوية المرافق" style="display:none">
        <div id="compFallback1" class="fallback">لا يوجد مرافق / لا توجد صور.</div>
        <div class="small" style="margin-top:8px" id="compLinks"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwCZv09zM2yklxDhjRUf3gU3KdQpXz7zazUfFpaEftr6oLRo_Ur2g6KattcXjJY3VvZOg/exec";
  const PAGE_SIZE = 25;

  // ✅ allowed statuses (used for dropdown in rows)
  const STATUS_OPTIONS = ["PENDING","RECEIVED","APPROVED","REJECTED","CANCELLED"];

  let token = localStorage.getItem("umrah_admin_token") || "";
  let offset = 0;
  let total = 0;

  function show(txt, type){
    const el = document.getElementById("msg");
    el.style.display = "block";
    el.className = "msg " + (type==="err" ? "err":"ok");
    el.textContent = txt;
  }
  function hideMsg(){ const el=document.getElementById("msg"); el.style.display="none"; }

  async function apiPost(obj, timeoutMs=60000){
    const ctrl = new AbortController();
    const timer = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const r = await fetch(API_URL, {
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify(obj),
        signal: ctrl.signal
      });
      const t = await r.text();
      let data;
      try{ data = JSON.parse(t); }catch(e){ data = {ok:false,error:"BAD_JSON",message:t.slice(0,250)}; }
      if(!r.ok) return { ok:false, error:"HTTP_"+r.status, message:data.message||("HTTP "+r.status) };
      return data;
    }catch(e){
      if(e.name==="AbortError") return {ok:false,error:"TIMEOUT",message:"الاتصال اتأخر. حاول تاني."};
      return {ok:false,error:"NETWORK_ERROR",message:"مشكلة اتصال. حاول تاني."};
    }finally{
      clearTimeout(timer);
    }
  }

  async function login(){
    hideMsg();
    const pw = (document.getElementById("pw").value || "");
    const btn = document.getElementById("btnLogin");
    btn.disabled = true;
    try{
      const r = await apiPost({ action:"admin_login", password: pw });
      if(r && r.ok && r.loggedIn){
        token = r.token;
        localStorage.setItem("umrah_admin_token", token);
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("adminBox").style.display = "block";
        await refreshAll();
        show("تم تسجيل الدخول.", "ok");
      }else{
        show(r.message || "كلمة المرور غير صحيحة.", "err");
      }
    }finally{
      btn.disabled = false;
    }
  }

  function logout(){
    localStorage.removeItem("umrah_admin_token");
    token = "";
    document.getElementById("adminBox").style.display = "none";
    document.getElementById("loginBox").style.display = "block";
    show("تم تسجيل الخروج.", "ok");
  }

  async function refreshAll(){
    await loadStats();
    await loadList(0);
  }

  async function loadStats(){
    const r = await apiPost({ action:"admin_stats", token });
    if(!r || !r.ok){
      show(r.message || r.error || "فشل تحميل الإحصائيات.", "err");
      if(String(r.error||"").includes("ADMIN_") || String(r.error||"").includes("TOKEN")) logout();
      return;
    }
    document.getElementById("st_total").textContent = r.total ?? 0;
    document.getElementById("st_with").textContent = r.with_companion ?? 0;
    document.getElementById("st_without").textContent = r.without_companion ?? 0;

    const st = r.statuses || {};
    const parts = Object.keys(st).map(k => `${k}:${st[k]}`);
    document.getElementById("st_statuses").textContent = parts.length ? parts.join(" | ") : "-";
  }

  function getFilters(){
    return {
      status: (document.getElementById("f_status").value || "").trim(),
      has_companion: (document.getElementById("f_has").value || "").trim()
    };
  }

  async function loadList(newOffset){
    hideMsg();
    offset = Math.max(0, newOffset || 0);
    const btn = document.getElementById("btnSearch");
    btn.disabled = true;
    try{
      const r = await apiPost({
        action:"admin_list",
        token,
        q: (document.getElementById("q").value || "").trim(),
        limit: PAGE_SIZE,
        offset,
        filters: getFilters()
      });

      if(!r || !r.ok){
        show(r.message || r.error || "فشل تحميل البيانات.", "err");
        if(String(r.error||"").includes("ADMIN_") || String(r.error||"").includes("TOKEN")) logout();
        return;
      }

      total = r.total || 0;
      renderRows(r.rows || []);
      renderPager();
    }finally{
      btn.disabled = false;
    }
  }

  function renderRows(rows){
    const tb = document.getElementById("rows");
    tb.innerHTML = "";

    if(!rows.length){
      tb.innerHTML = `<tr><td colspan="7" class="small">لا توجد نتائج.</td></tr>`;
      return;
    }

    for(const x of rows){
      const traveler = `
        <div><b>${esc(x.applicant_name||"-")}</b></div>
        <div class="small">مدني: ${esc(x.civil_id||"-")} | صندوق: ${esc(x.box_number||"-")}</div>
        <div class="small">موبايل: ${esc(x.mobile||"-")} | جواز: ${esc(x.passport_no||"-")}</div>
      `;

      const comp = (String(x.has_companion||"").toUpperCase()==="YES")
        ? `
          <div><b>${esc(x.companion_name||"-")}</b> <span class="pill">${esc(x.companion_type||"")}</span></div>
          <div class="small">مدني: ${esc(x.companion_civil_id||"-")} | جواز: ${esc(x.companion_passport_no||"-")}</div>
        `
        : `<div class="small">لا يوجد مرافق</div>`;

      // ✅ one "View Images" button (modal)
      const photosBtn = `
        <button style="background:#2563eb" onclick="openImgModal(
          '${escJs(x.request_id)}',
          '${escJs(x.applicant_civil_link||"")}',
          '${escJs(x.applicant_passport_link||"")}',
          '${escJs(x.companion_civil_link||"")}',
          '${escJs(x.companion_passport_link||"")}'
        )">عرض الصور</button>
        <div class="small" style="margin-top:6px">
          ${x.applicant_civil_link || x.applicant_passport_link ? `<span class="pill">مسافر</span>` : ``}
          ${x.companion_civil_link || x.companion_passport_link ? `<span class="pill">مرافق</span>` : ``}
        </div>
      `;

      // ✅ status dropdown per row
      const cur = String(x.status||"").trim().toUpperCase();
      const options = STATUS_OPTIONS.map(s => `<option value="${s}" ${s===cur?'selected':''}>${s}</option>`).join("");
      const stSel = `
        <select id="st_${escId(x.request_id)}" style="min-width:170px">
          <option value="">-- اختر --</option>
          ${options}
          ${(!STATUS_OPTIONS.includes(cur) && cur) ? `<option value="${escAttr(cur)}" selected>${esc(cur)} (قديم)</option>` : ``}
        </select>
        ${cur && !STATUS_OPTIONS.includes(cur) ? `<div class="small">⚠️ Status غير ضمن القائمة (تم إبقاؤه)</div>` : ``}
      `;

      const act = `
        <button onclick="saveStatus('${escJs(x.request_id)}')">حفظ</button>
      `;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${fmtDate(x.timestamp)}</td>
        <td><div><b>${esc(x.request_id||"-")}</b></div></td>
        <td>${traveler}</td>
        <td>${comp}</td>
        <td>${photosBtn}</td>
        <td>${stSel}</td>
        <td>${act}</td>
      `;
      tb.appendChild(tr);
    }
  }

  async function saveStatus(requestId){
    const sel = document.getElementById("st_" + escId(requestId));
    const newStatus = (sel?.value || "").trim();
    if(!newStatus){ show("اختر status أولاً.", "err"); return; }

    const r = await apiPost({ action:"admin_update_status", token, request_id: requestId, status: newStatus });
    if(r && r.ok && r.updated){
      show("تم تحديث الحالة.", "ok");
      await loadStats();
    }else{
      show(r.message || r.error || "لم يتم التحديث.", "err");
      if(String(r.error||"").includes("ADMIN_") || String(r.error||"").includes("TOKEN")) logout();
    }
  }

  function renderPager(){
    const from = total ? offset + 1 : 0;
    const to = Math.min(offset + PAGE_SIZE, total);
    document.getElementById("pageInfo").textContent = `عرض ${from} إلى ${to} من إجمالي ${total}`;

    document.getElementById("prev").disabled = offset <= 0;
    document.getElementById("next").disabled = (offset + PAGE_SIZE) >= total;
  }
  function prevPage(){ hideMsg(); loadList(offset - PAGE_SIZE); }
  function nextPage(){ hideMsg(); loadList(offset + PAGE_SIZE); }

  function fmtDate(v){
    try{
      const d = new Date(v);
      if(isNaN(d)) return esc(String(v||""));
      return d.toLocaleString("ar-KW");
    }catch(e){ return esc(String(v||"")); }
  }

  // ✅ Export CSV (requires GAS action admin_export_csv)
  function exportCSV(){
    if(!token){ show("سجّل دخول أولاً.", "err"); return; }
    const url = API_URL + "?action=admin_export_csv&token=" + encodeURIComponent(token);
    window.open(url, "_blank");
  }

  // ✅ Modal images
  function openImgModal(requestId, aCivil, aPass, cCivil, cPass){
    document.getElementById("imgModalTitle").textContent = "عرض الصور - " + (requestId || "");

    // traveler
    const travLinks = [];
    if(aCivil) travLinks.push(`<a target="_blank" rel="noopener" href="${escAttr(aCivil)}">هوية المسافر</a>`);
    if(aPass)  travLinks.push(`<a target="_blank" rel="noopener" href="${escAttr(aPass)}">جواز المسافر</a>`);
    document.getElementById("travLinks").innerHTML = travLinks.length ? travLinks.join(" | ") : "";

    // companion
    const compLinks = [];
    if(cCivil) compLinks.push(`<a target="_blank" rel="noopener" href="${escAttr(cCivil)}">هوية المرافق</a>`);
    if(cPass)  compLinks.push(`<a target="_blank" rel="noopener" href="${escAttr(cPass)}">جواز المرافق</a>`);
    document.getElementById("compLinks").innerHTML = compLinks.length ? compLinks.join(" | ") : "";

    // show one image preview per card (prefer civil then passport)
    setImgPreview("trav", aCivil || aPass, !!(aCivil || aPass));
    setImgPreview("comp", cCivil || cPass, !!(cCivil || cPass));

    document.getElementById("imgModal").style.display = "block";
  }

  function setImgPreview(prefix, url, hasAny){
    const img = document.getElementById(prefix + "Img1");
    const fb  = document.getElementById(prefix + "Fallback1");
    const open = document.getElementById(prefix + "Open1");

    if(hasAny && url){
      img.src = url;
      img.style.display = "block";
      fb.style.display = "none";
      open.href = url;
      open.style.display = "inline";
    }else{
      img.removeAttribute("src");
      img.style.display = "none";
      fb.style.display = "block";
      open.href = "#";
      open.style.display = "none";
    }
  }

  function closeImgModal(){
    document.getElementById("imgModal").style.display = "none";
  }
  function modalBackdropClose(e){
    // clicking backdrop closes
    closeImgModal();
  }

  // helpers escaping
  function esc(s){ return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
  function escAttr(s){ return String(s??"").replace(/"/g,"&quot;"); }
  function escJs(s){ return String(s??"").replace(/\\/g,"\\\\").replace(/'/g,"\\'"); }
  function escId(s){ return String(s??"").replace(/[^a-zA-Z0-9_-]/g,"_"); }

  // auto-login if token exists
  document.addEventListener("DOMContentLoaded", async ()=>{
    // Enter triggers search
    document.getElementById("q").addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){ loadList(0); }
    });

    if(token){
      document.getElementById("loginBox").style.display = "none";
      document.getElementById("adminBox").style.display = "block";
      await refreshAll();
    }
  });
</script>
</body>
</html>
