<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ø±Ø© 2026</title>
  <style>
    *{box-sizing:border-box}
    body{font-family:Arial,sans-serif;background:#f6f7fb;margin:0;padding:24px}
    .wrap{max-width:820px;margin:auto}
    .card{background:#fff;padding:22px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    h2{margin:0 0 14px;text-align:center}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:block;margin:10px 0 6px;font-weight:700}
    input,select{width:100%;padding:11px;border-radius:10px;border:1px solid #d8d8d8}
    .full{grid-column:1/-1}
    button{width:100%;margin-top:16px;padding:13px 16px;background:#2e7d32;color:#fff;border:0;border-radius:12px;cursor:pointer;font-size:16px}
    button:disabled{opacity:.6;cursor:not-allowed}
    .note{font-size:13px;color:#666;margin-top:8px}
    .msg{margin-top:14px;padding:12px;border-radius:12px;background:#f1f5ff;color:#123}
    .err{background:#fff3f3;color:#900}
    .ok{background:#f3fff3;color:#070}
    .sep{height:1px;background:#eee;margin:16px 0}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±Ø© 2026</h2>
    <div id="out" class="msg" style="display:none"></div>

    <div class="grid">
      <div>
        <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ</label>
        <input id="civil" disabled/>
      </div>
      <div>
        <label>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</label>
        <input id="box" disabled/>
      </div>

      <div class="full">
        <label>Ø§Ù„Ø§Ø³Ù…</label>
        <input id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„"/>
      </div>

      <div>
        <label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
        <input id="mobile" inputmode="tel" placeholder="Ù…Ø«Ø§Ù„: 5xxxxxxx"/>
      </div>
    
      <div class="full">
        <label>Ø±Ù‚Ù… Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±</label>
        <input id="passport_no" placeholder="Passport No."/>
      </div>

      <div class="full">
        <label>ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠØ© (Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ù‡ÙˆÙŠØªÙŠ)</label>
        <input id="app_civil_file" type="file" accept="image/*"/>
        <div class="note">Ø³ÙŠØªÙ… Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.</div>
      </div>

      <div class="full">
        <label>ØµÙˆØ±Ø© Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±</label>
        <input id="app_passport_file" type="file" accept="image/*"/>
        <div class="note">Ø³ÙŠØªÙ… Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.</div>
      </div>
    </div>

    <div class="sep"></div>

    <select id="has_companion" onchange="toggleCompanion()">
  <option value="no">Ù„Ø§</option>
  <option value="spouse">Ø²ÙˆØ¬/Ø²ÙˆØ¬Ø©</option>
  <option value="mahram">Ù…Ø­Ø±Ù…</option>
</select>

    <div id="companionBox" style="display:none;margin-top:10px">
      <div class="grid">
        <div class="full">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø§ÙÙ‚</label>
          <input id="c_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²ÙˆØ¬/Ø§Ù„Ø²ÙˆØ¬Ø©"/>
        </div>
        <div>
          <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ Ù„Ù„Ù…Ø±Ø§ÙÙ‚</label>
          <input id="c_civil" inputmode="numeric"/>
        </div>
        <div>
          <label>Ø±Ù‚Ù… Ø¬ÙˆØ§Ø² Ø§Ù„Ù…Ø±Ø§ÙÙ‚</label>
          <input id="c_passport_no"/>
        </div>

        <div class="full">
          <label>ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠØ© Ù„Ù„Ù…Ø±Ø§ÙÙ‚ (Ù‡ÙˆÙŠØªÙŠ)</label>
          <input id="c_civil_file" type="file" accept="image/*"/>
        </div>

        <div class="full">
          <label>ØµÙˆØ±Ø© Ø¬ÙˆØ§Ø² Ø§Ù„Ù…Ø±Ø§ÙÙ‚</label>
          <input id="c_passport_file" type="file" accept="image/*"/>
        </div>
      </div>
    </div>

    <button id="btn" onclick="submitForm()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    <div class="note">Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¥Ø±Ø³Ø§Ù„ØŒ Ø³ÙŠØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø¥Ù„Ù‰ Google Drive ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Google Sheets.</div>
  </div>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwCZv09zM2yklxDhjRUf3gU3KdQpXz7zazUfFpaEftr6oLRo_Ur2g6KattcXjJY3VvZOg/exec";

  // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±
  const IMG_MAX = 1600;     // Ø£Ù‚ØµÙ‰ Ø¨ÙØ¹Ø¯ (Ø¹Ø±Ø¶/Ø§Ø±ØªÙØ§Ø¹)
  const JPG_QUALITY = 0.72; // Ø¬ÙˆØ¯Ø© JPEG

  function getParam(name){
  return new URLSearchParams(window.location.search).get(name) || "";
}

window.addEventListener("load", function(){
  const civil = getParam("civil_id") || sessionStorage.getItem("civil_id") || "";
  const box   = getParam("box_number") || sessionStorage.getItem("box_number") || "";

  if (!civil || !box){
    location.href = "login.html";
    return;
  }

  document.getElementById("civil").value = civil;
  document.getElementById("box").value = box;
});
  
  function apiCall(params){
    return new Promise((resolve, reject)=>{
      const cbName = "__cb_" + Date.now() + "_" + Math.floor(Math.random()*100000);
      params.callback = cbName;

      const qs = new URLSearchParams(params).toString();
      const s = document.createElement("script");
      let done = false;

      window[cbName] = (data)=>{
        done = true;
        cleanup();
        resolve(data);
      };

      const t = setTimeout(()=>{
        if(!done){ cleanup(); reject(new Error("TIMEOUT")); }
      }, 30000);

      function cleanup(){
        clearTimeout(t);
        try{ delete window[cbName]; }catch(e){ window[cbName]=undefined; }
        if(s && s.parentNode) s.parentNode.removeChild(s);
      }

      s.src = API_URL + "?" + qs;
      s.onerror = ()=>{ cleanup(); reject(new Error("NETWORK_ERROR")); };
      document.body.appendChild(s);
    });
  }
async function apiPost(obj){
  const r = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(obj)
  });
  // GAS ÙŠØ±Ø¬Ø¹ JSON
  return await r.json();
}
  function toggleCompanion(){
  const v = document.getElementById("has_companion").value;
  const box = document.getElementById("companionBox");
  box.style.display = (v !== "no") ? "block" : "none";

  const nameInput = document.getElementById("c_name");
  if (nameInput) {
    nameInput.placeholder = (v === "mahram") ? "Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø±Ù…" : "Ø§Ø³Ù… Ø§Ù„Ø²ÙˆØ¬/Ø§Ù„Ø²ÙˆØ¬Ø©";
  }
}

  function showMsg(text, type){
    const out = document.getElementById("out");
    out.style.display="block";
    out.className = "msg " + (type==="ok" ? "ok" : type==="err" ? "err" : "");
    out.textContent = text;
  }

  function loadLogin(){
    const raw = sessionStorage.getItem("umrah_login");
    if(!raw){
      location.href="login.html";
      return;
    }
    const info = JSON.parse(raw);
    document.getElementById("civil").value = info.civil_id || "";
    document.getElementById("box").value = info.box_number || "";
    if(info.full_name) document.getElementById("name").value = info.full_name;
    if(info.mobile) document.getElementById("mobile").value = info.mobile;
  }

  // convert file -> compressed jpeg base64 (dataURL)
  function fileToCompressedJpegBase64(file, maxDim, quality){
    return new Promise((resolve, reject)=>{
      if(!file) return resolve("");
      const reader = new FileReader();
      reader.onload = ()=>{
        const img = new Image();
        img.onload = ()=>{
          const w = img.width, h = img.height;
          const scale = Math.min(1, maxDim / Math.max(w, h));
          const nw = Math.round(w * scale);
          const nh = Math.round(h * scale);

          const canvas = document.createElement("canvas");
          canvas.width = nw; canvas.height = nh;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, nw, nh);

          const dataUrl = canvas.toDataURL("image/jpeg", quality);
          resolve(dataUrl);
        };
        img.onerror = ()=>reject(new Error("BAD_IMAGE"));
        img.src = reader.result;
      };
      reader.onerror = ()=>reject(new Error("READ_ERROR"));
      reader.readAsDataURL(file);
    });
  }

  async function submitForm(){
  const btn = document.getElementById("btn");
  btn.disabled = true;
  btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

  let res = null;

  try{
    const civil_id = document.getElementById("civil").value.trim();
    const box_number = document.getElementById("box").value.trim();
    const applicant_name = document.getElementById("name").value.trim();
    const mobile = document.getElementById("mobile").value.trim();
    const passport_no = document.getElementById("passport_no").value.trim();

    // Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
    const fCivil = document.getElementById("app_civil_file").files[0];
    const fPass  = document.getElementById("app_passport_file").files[0];

    if(!fCivil || !fPass){
      showMsg("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠØ© ÙˆØµÙˆØ±Ø© Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±.", "err");
      return;
    }

    // ğŸ‘‡ Ù‡Ù†Ø§ ØªØ¶ØºØ· Ø§Ù„ØµÙˆØ±
    const civilImg = await fileToCompressedJpegBase64(fCivil, IMG_MAX, JPG_QUALITY);
    const passImg  = await fileToCompressedJpegBase64(fPass, IMG_MAX, JPG_QUALITY);

    // ğŸ‘‡ Ù‡Ù†Ø§ ØªØ¨Ù†ÙŠ Ø§Ù„Ù€ payload
    const payload = {
      civil_id,
      box_number,
      applicant_name,
      mobile,
      passport_no,
      civil_file: civilImg,
      passport_file: passImg
      // + Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§ÙÙ‚ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
    };

    // ğŸ‘‡ Ù‡Ù†Ø§ ÙÙ‚Ø· ØªØªØµÙ„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±
    res = await apiPost({ action:"submit", payload: payload });

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø¯
    if (res && res.ok && res.submitted === false && res.eligibility){
      showMsg(res.eligibility.message, "err");
      return;
    }

    if (res && res.ok && res.submitted === true){
      showMsg("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.", "ok");
      return;
    }

    showMsg("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.", "err");

  }catch(e){
  // âœ… Ù„Ùˆ ÙÙŠ Ø±Ø¯ ÙˆØµÙ„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø§Ù„ÙØ¹Ù„ Ø§Ø¹Ø±Ø¶Ù‡ Ø¨Ø¯Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
  if (res && res.eligibility && res.eligibility.message) {
    showMsg(res.eligibility.message, "err");
  } else if (res && (res.error || res.message)) {
    showMsg(res.error || res.message, "err");
  } else {
    showMsg("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "err");
  }
}finally{
  btn.disabled = false;
  btn.textContent = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
}
  loadLogin();
toggleCompanion();
</script>
</body>
</html>
