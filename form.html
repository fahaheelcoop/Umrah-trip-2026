<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ø±Ø© 2026</title>

<style>
*{box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#f6f7fb;margin:0;padding:24px}
.wrap{max-width:820px;margin:auto}
.card{background:#fff;padding:22px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
h2{margin:0 0 14px;text-align:center}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
label{display:block;margin:10px 0 6px;font-weight:700}
input,select{width:100%;padding:11px;border-radius:10px;border:1px solid #d8d8d8}
.full{grid-column:1/-1}
button{width:100%;margin-top:16px;padding:13px 16px;background:#2e7d32;color:#fff;border:0;border-radius:12px;cursor:pointer;font-size:16px}
button:disabled{opacity:.6;cursor:not-allowed}
.note{font-size:13px;color:#666;margin-top:8px}
.msg{margin-top:14px;padding:12px;border-radius:12px;display:none}
.err{background:#fff3f3;color:#900}
.ok{background:#f3fff3;color:#070}
.sep{height:1px;background:#eee;margin:16px 0}
</style>
</head>

<body>
<div class="wrap">
<div class="card">

<h2>Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±Ø© 2026</h2>
<div id="out" class="msg"></div>

<div class="grid">
<div>
<label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ</label>
<input id="civil" disabled/>
</div>

<div>
<label>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</label>
<input id="box" disabled/>
</div>

<div class="full">
<label>Ø§Ù„Ø§Ø³Ù…</label>
<input id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„"/>
</div>

<div>
<label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
<input id="mobile" inputmode="tel" placeholder="Ù…Ø«Ø§Ù„: 5xxxxxxx"/>
</div>

<div class="full">
<label>Ø±Ù‚Ù… Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±</label>
<input id="passport_no" placeholder="Passport No."/>
</div>

<div class="full">
<label>ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠØ©</label>
<input id="app_civil_file" type="file" accept="image/*"/>
</div>

<div class="full">
<label>ØµÙˆØ±Ø© Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±</label>
<input id="app_passport_file" type="file" accept="image/*"/>
</div>
</div>

<div class="sep"></div>

<select id="has_companion">
<option value="no">Ù„Ø§</option>
<option value="spouse">Ø²ÙˆØ¬/Ø²ÙˆØ¬Ø©</option>
<option value="mahram">Ù…Ø­Ø±Ù…</option>
</select>

<div id="companionBox" style="display:none; margin-top:15px;">
<div class="grid">
<div class="full">
<label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø§ÙÙ‚</label>
<input id="c_name"/>
</div>

<div>
<label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ Ù„Ù„Ù…Ø±Ø§ÙÙ‚</label>
<input id="c_civil" inputmode="numeric"/>
</div>

<div>
<label>Ø±Ù‚Ù… Ø¬ÙˆØ§Ø² Ø§Ù„Ù…Ø±Ø§ÙÙ‚</label>
<input id="c_passport_no"/>
</div>

<div class="full">
<label>ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠØ© Ù„Ù„Ù…Ø±Ø§ÙÙ‚</label>
<input id="c_civil_file" type="file" accept="image/*"/>
</div>

<div class="full">
<label>ØµÙˆØ±Ø© Ø¬ÙˆØ§Ø² Ø§Ù„Ù…Ø±Ø§ÙÙ‚</label>
<input id="c_passport_file" type="file" accept="image/*"/>
</div>
</div>
</div>

<button id="btn" type="button" onclick="submitForm()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>

</div>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwCZv09zM2yklxDhjRUf3gU3KdQpXz7zazUfFpaEftr6oLRo_Ur2g6KattcXjJY3VvZOg/exec";

  // ğŸ”¥ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…ÙƒØ§Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
async function apiPost(obj, timeoutMs = 60000){
  const ctrl = new AbortController();
  const timer = setTimeout(() => ctrl.abort(), timeoutMs);

  try{
    const r = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(obj),
      signal: ctrl.signal
    });

    const text = await r.text();

    let data = null;
    try { data = JSON.parse(text); }
    catch(e){
      data = { ok:false, error:"BAD_JSON", message:text.slice(0,250) };
    }

    if(!r.ok){
      return {
        ok:false,
        error:"HTTP_"+r.status,
        message:data.message || ("HTTP "+r.status)
      };
    }

    return data;

  }catch(e){
    if(e.name === "AbortError"){
      return { ok:false, error:"TIMEOUT", message:"Ø§Ù„Ø§ØªØµØ§Ù„ Ø§ØªØ£Ø®Ø±. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰." };
    }
    return { ok:false, error:"NETWORK_ERROR", message:"Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„. Ø­Ø§ÙˆÙ„ ØªØ§Ù†ÙŠ." };
  }finally{
    clearTimeout(timer);
  }
}

  const IMG_MAX = 1600;
  const JPG_QUALITY = 0.72;

  function showMsg(txt, type){
  const el = document.getElementById("out");
  if(!el) return;

  el.style.display = "block";
  el.className = "msg " + (type === "err" ? "err" : "ok");
  el.textContent = txt;

  // âœ… Ø®Ù„ÙŠÙ‡Ø§ ØªØ¸Ù‡Ø± Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ­Øª
  el.scrollIntoView({ behavior: "smooth", block: "center" });
}

  function getParam(name){
    return new URLSearchParams(window.location.search).get(name) || "";
  }

  function fillIds_(){
    const civil = (getParam("civil_id") || sessionStorage.getItem("civil_id") || "").trim();
    const box   = (getParam("box_number") || sessionStorage.getItem("box_number") || "").trim();

    const civilEl = document.getElementById("civil");
    const boxEl   = document.getElementById("box");
    if(civilEl) civilEl.value = civil;
    if(boxEl)   boxEl.value = box;
  }

  function toggleCompanion(){
    const sel = document.getElementById("has_companion");
    const box = document.getElementById("companionBox");
    if(!sel || !box) return;

    const val = (sel.value || "").trim();
    box.style.display = (val === "spouse" || val === "mahram") ? "block" : "none";
  }

  // âœ… Ø±Ø¨Ø· Ù…Ø¶Ù…ÙˆÙ† + ØªØ´ØºÙŠÙ„ Ù…Ø±Ø© Ø£ÙˆÙ„ Ù…Ø§ Ø§Ù„ØµÙØ­Ø© ØªÙØªØ­
  document.addEventListener("DOMContentLoaded", ()=>{
    fillIds_();

    const sel = document.getElementById("has_companion");
    if(sel){
      sel.addEventListener("change", toggleCompanion);
      toggleCompanion();
    }
  });

  window.addEventListener("pageshow", fillIds_);

  // ========= Ø¶ØºØ· Ø§Ù„ØµÙˆØ± =========
  function fileToCompressedJpegBase64(file, maxDim, quality){
    return new Promise((resolve, reject)=>{
      if(!file) return resolve("");
      const reader = new FileReader();
      reader.onload = ()=>{
        const img = new Image();
        img.onload = ()=>{
          const w = img.width, h = img.height;
          const scale = Math.min(1, maxDim / Math.max(w, h));
          const nw = Math.round(w * scale);
          const nh = Math.round(h * scale);

          const canvas = document.createElement("canvas");
          canvas.width = nw;
          canvas.height = nh;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, nw, nh);

          const dataUrl = canvas.toDataURL("image/jpeg", quality);
          resolve(dataUrl);
        };
        img.onerror = ()=>reject(new Error("BAD_IMAGE"));
        img.src = reader.result;
      };
      reader.onerror = ()=>reject(new Error("READ_ERROR"));
      reader.readAsDataURL(file);
    });
  }

  async function submitForm(){
    const btn = document.getElementById("btn");
    btn.disabled = true;
    btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

    try{
      const civil_id = (document.getElementById("civil")?.value || "").trim();
      const box_number = (document.getElementById("box")?.value || "").trim();
      const applicant_name = (document.getElementById("name")?.value || "").trim();
      const mobile = (document.getElementById("mobile")?.value || "").trim();
      const passport_no = (document.getElementById("passport_no")?.value || "").trim();

      const fCivil = document.getElementById("app_civil_file")?.files?.[0];
      const fPass  = document.getElementById("app_passport_file")?.files?.[0];

      if(!fCivil || !fPass){
        showMsg("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠØ© ÙˆØµÙˆØ±Ø© Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±.", "err");
        return;
      }

      const civilImg = await fileToCompressedJpegBase64(fCivil, IMG_MAX, JPG_QUALITY);
      const passImg  = await fileToCompressedJpegBase64(fPass, IMG_MAX, JPG_QUALITY);

      const compVal = document.getElementById("has_companion")?.value || "no";
      const hasCompanion = compVal !== "no";

      const payload = {
        civil_id,
        box_number,
        applicant_name,
        mobile,
        passport_no,
        applicant_civil_base64: civilImg,
        applicant_passport_base64: passImg,

        has_companion: hasCompanion,
        companion_type: compVal,
        companion_name: (document.getElementById("c_name")?.value || "").trim(),
        companion_civil_id: (document.getElementById("c_civil")?.value || "").trim(),
        companion_passport_no: (document.getElementById("c_passport_no")?.value || "").trim()
      };

      if(hasCompanion){
        const cCivilFile = document.getElementById("c_civil_file")?.files?.[0];
        const cPassFile  = document.getElementById("c_passport_file")?.files?.[0];

        if(!cCivilFile || !cPassFile){
          showMsg("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ù…Ø±Ø§ÙÙ‚ (Ù‡ÙˆÙŠØªÙŠ + Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±).", "err");
          return;
        }

        payload.companion_civil_base64 = await fileToCompressedJpegBase64(cCivilFile, IMG_MAX, JPG_QUALITY);
        payload.companion_passport_base64 = await fileToCompressedJpegBase64(cPassFile, IMG_MAX, JPG_QUALITY);
      }

      const res = await apiPost({ action:"submit", payload });
      
      if(res && res.ok && res.submitted === false && res.eligibility){
        showMsg(res.eligibility.message || "ØºÙŠØ± Ù…Ø¤Ù‡Ù„.", "err");
        return;
      }

      if(res && res.ok && res.submitted === true){
  // âœ… Ø®Ø²Ù‘Ù† Ø¢Ø®Ø± Ø·Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  sessionStorage.setItem("last_submit", JSON.stringify({
    civil_id,
    box_number,
    request_id: res.request_id || "",
    already: 0
  }));

  // âœ… Ø±ÙˆØ­ Ù„ØµÙØ­Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
  location.href = "success.html?civil_id="
    + encodeURIComponent(civil_id)
    + "&box_number="
    + encodeURIComponent(box_number)
    + (res.request_id ? "&request_id=" + encodeURIComponent(res.request_id) : "");

  return;
}

      showMsg(res?.error || res?.message || "Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.", "err");

    }catch(e){
      console.error(e);
      showMsg("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "err");
    }finally{
      btn.disabled = false;
      btn.textContent = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
    }
  }
</script>
</body>
</html>
